-- Migration: Complete production setup
-- Esta migration replica exatamente o estado atual do banco local
-- Data: 2025-09-11T02:12:05.576Z

-- Habilitar extensões necessárias
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- Criar todos os tipos ENUM necessários
CREATE TYPE IF NOT EXISTS rate_shopper_alert_type AS ENUM ('PRICE_DROP', 'PRICE_INCREASE', 'AVAILABILITY_CHANGE', 'CUSTOM');\nCREATE TYPE IF NOT EXISTS rate_shopper_availability_status AS ENUM ('AVAILABLE', 'LIMITED', 'SOLD_OUT');\nCREATE TYPE IF NOT EXISTS rate_shopper_competitor_type AS ENUM ('DIRECT', 'OTA');\nCREATE TYPE IF NOT EXISTS rate_shopper_condition_operator AS ENUM ('GREATER_THAN', 'LESS_THAN', 'EQUALS', 'PERCENTAGE_CHANGE');\nCREATE TYPE IF NOT EXISTS rate_shopper_job_type AS ENUM ('SEARCH', 'REPORT', 'ALERT_CHECK', 'CLEANUP');\nCREATE TYPE IF NOT EXISTS rate_shopper_price_change_type AS ENUM ('UP', 'DOWN', 'STABLE', 'NEW');\nCREATE TYPE IF NOT EXISTS rate_shopper_report_status AS ENUM ('GENERATING', 'COMPLETED', 'FAILED');\nCREATE TYPE IF NOT EXISTS rate_shopper_report_type AS ENUM ('DAILY', 'WEEKLY', 'MONTHLY', 'CUSTOM', 'COMPETITIVE_ANALYSIS');\nCREATE TYPE IF NOT EXISTS rate_shopper_search_type AS ENUM ('MANUAL', 'SCHEDULED');\nCREATE TYPE IF NOT EXISTS rate_shopper_status AS ENUM ('PENDING', 'RUNNING', 'COMPLETED', 'FAILED', 'CANCELLED');\n\n-- Função para atualizar timestamps
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Tabela para controle de migrations
CREATE TABLE IF NOT EXISTS schema_migrations (
  id SERIAL PRIMARY KEY,
  version VARCHAR(255) UNIQUE NOT NULL,
  filename VARCHAR(255) NOT NULL,
  executed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  checksum VARCHAR(64),
  execution_time_ms INTEGER
);

-- Tabela: app_config\nCREATE TABLE IF NOT EXISTS app_config (\n  id INTEGER NOT NULL DEFAULT nextval('app_config_id_seq'::regclass),\n  hotel_id INTEGER,\n  config_key VARCHAR(255) NOT NULL,\n  config_value TEXT,\n  config_type VARCHAR(20) DEFAULT 'STRING'::character varying,\n  description TEXT,\n  created_at TIMESTAMP DEFAULT now(),\n  updated_at TIMESTAMP DEFAULT now()\n);\n\nALTER TABLE app_config ADD PRIMARY KEY (id);\n\n-- Tabela: app_configurations\nCREATE TABLE IF NOT EXISTS app_configurations (\n  id INTEGER NOT NULL DEFAULT nextval('app_configurations_id_seq'::regclass),\n  hotel_id UUID,\n  app_name VARCHAR(50) NOT NULL,\n  app_title VARCHAR(255) DEFAULT NULL::character varying,\n  logo_url TEXT,\n  is_active BOOLEAN DEFAULT true,\n  shared_from_app VARCHAR(50),\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  favicon_url TEXT,\n  description TEXT\n);\n\nALTER TABLE app_configurations ADD PRIMARY KEY (id);\n\n-- Tabela: bot_fields\nCREATE TABLE IF NOT EXISTS bot_fields (\n  id INTEGER NOT NULL DEFAULT nextval('bot_fields_id_seq'::regclass),\n  hotel_id INTEGER,\n  field_key VARCHAR(255) NOT NULL,\n  field_value TEXT,\n  field_type VARCHAR(20) DEFAULT 'STRING'::character varying,\n  category VARCHAR(100),\n  description TEXT,\n  active BOOLEAN DEFAULT true,\n  created_at TIMESTAMP DEFAULT now(),\n  updated_at TIMESTAMP DEFAULT now()\n);\n\nALTER TABLE bot_fields ADD PRIMARY KEY (id);\n\n-- Tabela: bots\nCREATE TABLE IF NOT EXISTS bots (\n  id INTEGER NOT NULL DEFAULT nextval('bots_id_seq'::regclass),\n  uuid UUID NOT NULL DEFAULT gen_random_uuid(),\n  workspace_id INTEGER NOT NULL,\n  workspace_uuid UUID NOT NULL,\n  hotel_id INTEGER NOT NULL,\n  hotel_uuid UUID NOT NULL,\n  name VARCHAR(255) NOT NULL,\n  description TEXT,\n  bot_type VARCHAR(50) DEFAULT 'CHATBOT'::character varying,\n  status VARCHAR(20) DEFAULT 'DRAFT'::character varying,\n  configuration JSONB,\n  settings JSONB,\n  active BOOLEAN DEFAULT true,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nALTER TABLE bots ADD PRIMARY KEY (id);\n\n-- Tabela: flows\nCREATE TABLE IF NOT EXISTS flows (\n  id INTEGER NOT NULL DEFAULT nextval('flows_id_seq'::regclass),\n  flow_uuid UUID NOT NULL DEFAULT gen_random_uuid(),\n  bot_id INTEGER NOT NULL,\n  bot_uuid UUID NOT NULL,\n  workspace_id INTEGER NOT NULL,\n  workspace_uuid UUID NOT NULL,\n  hotel_id INTEGER NOT NULL,\n  hotel_uuid UUID NOT NULL,\n  folder_id INTEGER,\n  name VARCHAR(255) NOT NULL,\n  description TEXT,\n  flow_type VARCHAR(20) DEFAULT 'CONVERSATION'::character varying,\n  status VARCHAR(20) DEFAULT 'DRAFT'::character varying,\n  version VARCHAR(20) DEFAULT '1.0.0'::character varying,\n  flow_data JSONB,\n  variables JSONB,\n  settings JSONB,\n  triggers JSONB,\n  priority INTEGER DEFAULT 0,\n  is_default BOOLEAN DEFAULT false,\n  execution_count INTEGER DEFAULT 0,\n  last_executed_at TIMESTAMP,\n  sort_order INTEGER DEFAULT 0,\n  active BOOLEAN DEFAULT true,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nALTER TABLE flows ADD PRIMARY KEY (id);\n\n-- Tabela: folders\nCREATE TABLE IF NOT EXISTS folders (\n  id INTEGER NOT NULL DEFAULT nextval('folders_id_seq'::regclass),\n  folder_uuid UUID NOT NULL DEFAULT gen_random_uuid(),\n  bot_id INTEGER NOT NULL,\n  bot_uuid UUID NOT NULL,\n  workspace_id INTEGER NOT NULL,\n  workspace_uuid UUID NOT NULL,\n  hotel_id INTEGER NOT NULL,\n  hotel_uuid UUID NOT NULL,\n  name VARCHAR(255) NOT NULL,\n  description TEXT,\n  color VARCHAR(7) DEFAULT '#3B82F6'::character varying,\n  icon VARCHAR(50) DEFAULT 'folder'::character varying,\n  parent_folder_id INTEGER,\n  sort_order INTEGER DEFAULT 0,\n  active BOOLEAN DEFAULT true,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nALTER TABLE folders ADD PRIMARY KEY (id);\n\n-- Tabela: hotel_sites\nCREATE TABLE IF NOT EXISTS hotel_sites (\n  id INTEGER NOT NULL DEFAULT nextval('hotel_sites_id_seq'::regclass),\n  site_uuid UUID DEFAULT gen_random_uuid(),\n  hotel_id INTEGER NOT NULL,\n  name VARCHAR(255) NOT NULL,\n  subdomain VARCHAR(100),\n  custom_domain VARCHAR(255),\n  description TEXT,\n  theme_id INTEGER,\n  settings JSONB,\n  seo_title VARCHAR(255),\n  seo_description TEXT,\n  seo_keywords TEXT,\n  seo_config JSONB,\n  analytics_config JSONB,\n  published BOOLEAN DEFAULT false,\n  published_at TIMESTAMP,\n  plan_type VARCHAR(20) DEFAULT 'STARTER'::character varying,\n  active BOOLEAN DEFAULT true,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nALTER TABLE hotel_sites ADD PRIMARY KEY (id);\n\n-- Tabela: hotels\nCREATE TABLE IF NOT EXISTS hotels (\n  id INTEGER NOT NULL DEFAULT nextval('hotels_id_seq'::regclass),\n  hotel_uuid UUID NOT NULL DEFAULT uuid_generate_v4(),\n  name VARCHAR(255) NOT NULL,\n  checkin_time TIME DEFAULT '14:00:00'::time without time zone,\n  checkout_time TIME DEFAULT '12:00:00'::time without time zone,\n  cover_image TEXT,\n  description TEXT,\n  address TEXT,\n  phone VARCHAR(50),\n  email VARCHAR(255),\n  website VARCHAR(255),\n  status VARCHAR(20) DEFAULT 'ACTIVE'::character varying,\n  created_at TIMESTAMP DEFAULT now(),\n  updated_at TIMESTAMP DEFAULT now()\n);\n\nALTER TABLE hotels ADD PRIMARY KEY (id);\n\n-- Tabela: logo_history\nCREATE TABLE IF NOT EXISTS logo_history (\n  id INTEGER NOT NULL DEFAULT nextval('logo_history_id_seq'::regclass),\n  hotel_id INTEGER,\n  logo_url TEXT NOT NULL,\n  is_active BOOLEAN DEFAULT false,\n  upload_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nALTER TABLE logo_history ADD PRIMARY KEY (id);\n\n-- Tabela: meta_available_accounts\nCREATE TABLE IF NOT EXISTS meta_available_accounts (\n  id INTEGER NOT NULL DEFAULT nextval('meta_available_accounts_id_seq'::regclass),\n  hotel_uuid UUID NOT NULL,\n  account_id VARCHAR(255) NOT NULL,\n  account_name VARCHAR(255),\n  account_status INTEGER DEFAULT 1,\n  currency VARCHAR(10),\n  business_id VARCHAR(255),\n  business_name VARCHAR(255),\n  is_connected BOOLEAN DEFAULT false,\n  created_at TIMESTAMP DEFAULT now(),\n  updated_at TIMESTAMP DEFAULT now()\n);\n\nALTER TABLE meta_available_accounts ADD PRIMARY KEY (id);\n\n-- Tabela: meta_connected_accounts\nCREATE TABLE IF NOT EXISTS meta_connected_accounts (\n  id INTEGER NOT NULL DEFAULT nextval('meta_connected_accounts_id_seq'::regclass),\n  hotel_uuid UUID NOT NULL,\n  account_id VARCHAR(255) NOT NULL,\n  account_name VARCHAR(255),\n  access_token TEXT,\n  account_status INTEGER DEFAULT 1,\n  currency VARCHAR(10),\n  business_id VARCHAR(255),\n  business_name VARCHAR(255),\n  created_at TIMESTAMP DEFAULT now(),\n  updated_at TIMESTAMP DEFAULT now()\n);\n\nALTER TABLE meta_connected_accounts ADD PRIMARY KEY (id);\n\n-- Tabela: meta_sync_logs\nCREATE TABLE IF NOT EXISTS meta_sync_logs (\n  id INTEGER NOT NULL DEFAULT nextval('meta_sync_logs_id_seq'::regclass),\n  hotel_uuid UUID NOT NULL,\n  sync_type VARCHAR(50) NOT NULL,\n  status VARCHAR(20) DEFAULT 'PENDING'::character varying,\n  records_processed INTEGER DEFAULT 0,\n  error_message TEXT,\n  started_at TIMESTAMP DEFAULT now(),\n  completed_at TIMESTAMP,\n  created_at TIMESTAMP DEFAULT now(),\n  updated_at TIMESTAMP DEFAULT now()\n);\n\nALTER TABLE meta_sync_logs ADD PRIMARY KEY (id);\n\n-- Tabela: oauth_states\nCREATE TABLE IF NOT EXISTS oauth_states (\n  id INTEGER NOT NULL DEFAULT nextval('oauth_states_id_seq'::regclass),\n  state VARCHAR(255) NOT NULL,\n  hotel_uuid UUID NOT NULL,\n  created_at TIMESTAMP DEFAULT now(),\n  expires_at TIMESTAMP NOT NULL\n);\n\nALTER TABLE oauth_states ADD PRIMARY KEY (id);\n\n-- Tabela: onenode_bot_fields\nCREATE TABLE IF NOT EXISTS onenode_bot_fields (\n  id INTEGER NOT NULL DEFAULT nextval('onenode_bot_fields_id_seq'::regclass),\n  hotel_uuid VARCHAR(36) NOT NULL,\n  name VARCHAR(255),\n  var_ns VARCHAR(32) NOT NULL,\n  var_type VARCHAR(20) DEFAULT 'STRING'::character varying,\n  description TEXT,\n  value TEXT,\n  workspace_id INTEGER,\n  is_required BOOLEAN DEFAULT false,\n  is_custom BOOLEAN DEFAULT true,\n  active BOOLEAN DEFAULT true,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nALTER TABLE onenode_bot_fields ADD PRIMARY KEY (id);\n\n-- Tabela: rate_shopper_alert_history\nCREATE TABLE IF NOT EXISTS rate_shopper_alert_history (\n  id INTEGER NOT NULL DEFAULT nextval('rate_shopper_alert_history_id_seq'::regclass),\n  alert_id INTEGER NOT NULL,\n  search_id INTEGER,\n  price_id INTEGER,\n  triggered_value NUMERIC(10,2),\n  message TEXT,\n  notification_sent BOOLEAN DEFAULT false,\n  notification_channels_used TEXT,\n  triggered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nALTER TABLE rate_shopper_alert_history ADD PRIMARY KEY (id);\n\n-- Tabela: rate_shopper_alerts\nCREATE TABLE IF NOT EXISTS rate_shopper_alerts (\n  id INTEGER NOT NULL DEFAULT nextval('rate_shopper_alerts_id_seq'::regclass),\n  uuid UUID NOT NULL DEFAULT uuid_generate_v4(),\n  hotel_id INTEGER NOT NULL,\n  property_id INTEGER,\n  alert_name VARCHAR(255) NOT NULL,\n  alert_type rate_shopper_alert_type NOT NULL,\n  condition_field VARCHAR(100) NOT NULL,\n  condition_operator rate_shopper_condition_operator NOT NULL,\n  condition_value NUMERIC(10,2) NOT NULL,\n  date_range_start DATE,\n  date_range_end DATE,\n  notification_channels TEXT,\n  active BOOLEAN DEFAULT true,\n  last_triggered_at TIMESTAMP,\n  trigger_count INTEGER DEFAULT 0,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nALTER TABLE rate_shopper_alerts ADD PRIMARY KEY (id);\n\n-- Tabela: rate_shopper_configs\nCREATE TABLE IF NOT EXISTS rate_shopper_configs (\n  id INTEGER NOT NULL DEFAULT nextval('rate_shopper_configs_id_seq'::regclass),\n  hotel_id INTEGER NOT NULL,\n  auto_search_enabled BOOLEAN DEFAULT false,\n  search_frequency_hours INTEGER DEFAULT 8,\n  date_range_days INTEGER DEFAULT 90,\n  max_bundle_size INTEGER DEFAULT 7,\n  notification_enabled BOOLEAN DEFAULT true,\n  notification_emails TEXT,\n  price_alert_threshold NUMERIC(5,2) DEFAULT 10.00,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nALTER TABLE rate_shopper_configs ADD PRIMARY KEY (id);\n\n-- Tabela: rate_shopper_price_history\nCREATE TABLE IF NOT EXISTS rate_shopper_price_history (\n  id INTEGER NOT NULL DEFAULT nextval('rate_shopper_price_history_id_seq'::regclass),\n  property_id INTEGER NOT NULL,\n  hotel_id INTEGER NOT NULL,\n  check_in_date DATE NOT NULL,\n  current_price NUMERIC(10,2) NOT NULL,\n  previous_price NUMERIC(10,2),\n  price_change NUMERIC(10,2) DEFAULT 0,\n  change_percentage NUMERIC(5,2) DEFAULT 0,\n  change_type rate_shopper_price_change_type DEFAULT 'NEW'::rate_shopper_price_change_type,\n  search_id INTEGER,\n  currency VARCHAR(3) DEFAULT 'BRL'::character varying,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nALTER TABLE rate_shopper_price_history ADD PRIMARY KEY (id);\n\n-- Tabela: rate_shopper_prices\nCREATE TABLE IF NOT EXISTS rate_shopper_prices (\n  id INTEGER NOT NULL DEFAULT nextval('rate_shopper_prices_id_seq'::regclass),\n  search_id INTEGER NOT NULL,\n  property_id INTEGER NOT NULL,\n  hotel_id INTEGER NOT NULL,\n  check_in_date DATE NOT NULL,\n  check_out_date DATE NOT NULL,\n  price NUMERIC(10,2) NOT NULL,\n  currency VARCHAR(3) DEFAULT 'BRL'::character varying,\n  room_type VARCHAR(255),\n  max_guests INTEGER DEFAULT 2,\n  is_bundle BOOLEAN DEFAULT false,\n  bundle_size INTEGER DEFAULT 1,\n  original_price NUMERIC(10,2),\n  availability_status rate_shopper_availability_status DEFAULT 'AVAILABLE'::rate_shopper_availability_status,\n  extraction_method VARCHAR(50) DEFAULT 'JS_VARS'::character varying,\n  scraped_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nALTER TABLE rate_shopper_prices ADD PRIMARY KEY (id);\n\n-- Tabela: rate_shopper_properties\nCREATE TABLE IF NOT EXISTS rate_shopper_properties (\n  id INTEGER NOT NULL DEFAULT nextval('rate_shopper_properties_id_seq'::regclass),\n  uuid UUID NOT NULL DEFAULT uuid_generate_v4(),\n  hotel_id INTEGER NOT NULL,\n  property_name VARCHAR(255) NOT NULL,\n  booking_url TEXT NOT NULL,\n  competitor_type rate_shopper_competitor_type DEFAULT 'OTA'::rate_shopper_competitor_type,\n  ota_name VARCHAR(100) DEFAULT 'Booking.com'::character varying,\n  location VARCHAR(255),\n  category VARCHAR(100),\n  max_bundle_size INTEGER DEFAULT 7,\n  active BOOLEAN DEFAULT true,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  is_main_property BOOLEAN DEFAULT false,\n  platform VARCHAR(20) DEFAULT 'booking'::character varying\n);\n\nALTER TABLE rate_shopper_properties ADD PRIMARY KEY (id);\n\n-- Tabela: rate_shopper_queue\nCREATE TABLE IF NOT EXISTS rate_shopper_queue (\n  id INTEGER NOT NULL DEFAULT nextval('rate_shopper_queue_id_seq'::regclass),\n  job_id VARCHAR(100) NOT NULL,\n  job_type rate_shopper_job_type NOT NULL,\n  job_data TEXT,\n  priority INTEGER DEFAULT 0,\n  status rate_shopper_status DEFAULT 'PENDING'::rate_shopper_status,\n  attempts INTEGER DEFAULT 0,\n  max_attempts INTEGER DEFAULT 3,\n  error_message TEXT,\n  scheduled_for TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  started_at TIMESTAMP,\n  completed_at TIMESTAMP,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nALTER TABLE rate_shopper_queue ADD PRIMARY KEY (id);\n\n-- Tabela: rate_shopper_reports\nCREATE TABLE IF NOT EXISTS rate_shopper_reports (\n  id INTEGER NOT NULL DEFAULT nextval('rate_shopper_reports_id_seq'::regclass),\n  uuid UUID NOT NULL DEFAULT uuid_generate_v4(),\n  hotel_id INTEGER NOT NULL,\n  report_name VARCHAR(255) NOT NULL,\n  report_type rate_shopper_report_type NOT NULL,\n  date_range_start DATE NOT NULL,\n  date_range_end DATE NOT NULL,\n  properties_included TEXT,\n  report_data TEXT,\n  file_path VARCHAR(500),\n  file_type VARCHAR(10),\n  status rate_shopper_report_status DEFAULT 'GENERATING'::rate_shopper_report_status,\n  generated_at TIMESTAMP,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nALTER TABLE rate_shopper_reports ADD PRIMARY KEY (id);\n\n-- Tabela: rate_shopper_searches\nCREATE TABLE IF NOT EXISTS rate_shopper_searches (\n  id INTEGER NOT NULL DEFAULT nextval('rate_shopper_searches_id_seq'::regclass),\n  uuid UUID NOT NULL DEFAULT uuid_generate_v4(),\n  hotel_id INTEGER NOT NULL,\n  property_id INTEGER,\n  search_type rate_shopper_search_type DEFAULT 'MANUAL'::rate_shopper_search_type,\n  start_date DATE NOT NULL,\n  end_date DATE NOT NULL,\n  status rate_shopper_status DEFAULT 'PENDING'::rate_shopper_status,\n  total_dates INTEGER DEFAULT 0,\n  processed_dates INTEGER DEFAULT 0,\n  total_prices_found INTEGER DEFAULT 0,\n  error_log TEXT,\n  started_at TIMESTAMP,\n  completed_at TIMESTAMP,\n  duration_seconds INTEGER DEFAULT 0,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nALTER TABLE rate_shopper_searches ADD PRIMARY KEY (id);\n\n-- Tabela: site_analytics\nCREATE TABLE IF NOT EXISTS site_analytics (\n  id INTEGER NOT NULL DEFAULT nextval('site_analytics_id_seq'::regclass),\n  site_id INTEGER NOT NULL,\n  page_url VARCHAR(500),\n  visitor_ip VARCHAR(45),\n  user_agent TEXT,\n  referrer TEXT,\n  session_id VARCHAR(100),\n  event_type VARCHAR(50) DEFAULT 'page_view'::character varying,\n  event_data JSONB,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nALTER TABLE site_analytics ADD PRIMARY KEY (id);\n\n-- Tabela: site_bookings\nCREATE TABLE IF NOT EXISTS site_bookings (\n  id INTEGER NOT NULL DEFAULT nextval('site_bookings_id_seq'::regclass),\n  site_id INTEGER NOT NULL,\n  guest_name VARCHAR(255) NOT NULL,\n  guest_email VARCHAR(255) NOT NULL,\n  guest_phone VARCHAR(20),\n  check_in DATE NOT NULL,\n  check_out DATE NOT NULL,\n  guests_count INTEGER DEFAULT 1,\n  room_type VARCHAR(100),\n  special_requests TEXT,\n  total_amount NUMERIC(10,2),\n  booking_status VARCHAR(20) DEFAULT 'PENDING'::character varying,\n  payment_status VARCHAR(20) DEFAULT 'PENDING'::character varying,\n  confirmation_code VARCHAR(20),\n  notes TEXT,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nALTER TABLE site_bookings ADD PRIMARY KEY (id);\n\n-- Tabela: site_form_submissions\nCREATE TABLE IF NOT EXISTS site_form_submissions (\n  id INTEGER NOT NULL DEFAULT nextval('site_form_submissions_id_seq'::regclass),\n  site_id INTEGER,\n  form_type VARCHAR(50) NOT NULL,\n  form_data JSONB NOT NULL,\n  visitor_ip INET,\n  user_agent TEXT,\n  submitted_at TIMESTAMP DEFAULT now(),\n  status VARCHAR(20) DEFAULT 'new'::character varying,\n  notes TEXT\n);\n\nALTER TABLE site_form_submissions ADD PRIMARY KEY (id);\n\n-- Tabela: site_media\nCREATE TABLE IF NOT EXISTS site_media (\n  id INTEGER NOT NULL DEFAULT nextval('site_media_id_seq'::regclass),\n  site_id INTEGER NOT NULL,\n  filename VARCHAR(255) NOT NULL,\n  original_name VARCHAR(255),\n  mime_type VARCHAR(100),\n  file_size INTEGER,\n  file_path TEXT NOT NULL,\n  alt_text TEXT,\n  caption TEXT,\n  is_featured BOOLEAN DEFAULT false,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nALTER TABLE site_media ADD PRIMARY KEY (id);\n\n-- Tabela: site_pages\nCREATE TABLE IF NOT EXISTS site_pages (\n  id INTEGER NOT NULL DEFAULT nextval('site_pages_id_seq'::regclass),\n  site_id INTEGER NOT NULL,\n  title VARCHAR(255) NOT NULL,\n  slug VARCHAR(255) NOT NULL,\n  content JSONB,\n  meta_title VARCHAR(255),\n  meta_description TEXT,\n  is_homepage BOOLEAN DEFAULT false,\n  is_system_page BOOLEAN DEFAULT false,\n  published BOOLEAN DEFAULT true,\n  sort_order INTEGER DEFAULT 0,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nALTER TABLE site_pages ADD PRIMARY KEY (id);\n\n-- Tabela: site_templates\nCREATE TABLE IF NOT EXISTS site_templates (\n  id INTEGER NOT NULL DEFAULT nextval('site_templates_id_seq'::regclass),\n  name VARCHAR(255) NOT NULL,\n  category VARCHAR(100) NOT NULL,\n  description TEXT,\n  preview_image TEXT,\n  html_structure JSONB NOT NULL,\n  css_styles JSONB NOT NULL,\n  default_content JSONB NOT NULL,\n  features JSONB DEFAULT '[]'::jsonb,\n  is_premium BOOLEAN DEFAULT false,\n  price NUMERIC(10,2) DEFAULT 0.00,\n  is_active BOOLEAN DEFAULT true,\n  created_at TIMESTAMP DEFAULT now(),\n  updated_at TIMESTAMP DEFAULT now()\n);\n\nALTER TABLE site_templates ADD PRIMARY KEY (id);\n\n-- Tabela: site_themes\nCREATE TABLE IF NOT EXISTS site_themes (\n  id INTEGER NOT NULL DEFAULT nextval('site_themes_id_seq'::regclass),\n  name VARCHAR(100) NOT NULL,\n  category VARCHAR(50),\n  thumbnail_url TEXT,\n  preview_url TEXT,\n  config JSONB,\n  styles JSONB,\n  components JSONB,\n  is_premium BOOLEAN DEFAULT false,\n  price NUMERIC(10,2) DEFAULT 0.00,\n  active BOOLEAN DEFAULT true,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nALTER TABLE site_themes ADD PRIMARY KEY (id);\n\n-- Tabela: user_hotels\nCREATE TABLE IF NOT EXISTS user_hotels (\n  id INTEGER NOT NULL DEFAULT nextval('user_hotels_id_seq'::regclass),\n  user_id INTEGER,\n  hotel_id INTEGER,\n  role VARCHAR(50) DEFAULT 'STAFF'::character varying,\n  permissions JSONB DEFAULT '{}'::jsonb,\n  active BOOLEAN DEFAULT true,\n  created_at TIMESTAMP DEFAULT now(),\n  updated_at TIMESTAMP DEFAULT now()\n);\n\nALTER TABLE user_hotels ADD PRIMARY KEY (id);\n\n-- Tabela: user_permissions\nCREATE TABLE IF NOT EXISTS user_permissions (\n  id INTEGER NOT NULL DEFAULT nextval('user_permissions_id_seq'::regclass),\n  user_id INTEGER NOT NULL,\n  permission VARCHAR(255) NOT NULL,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nALTER TABLE user_permissions ADD PRIMARY KEY (id);\n\n-- Tabela: users\nCREATE TABLE IF NOT EXISTS users (\n  id INTEGER NOT NULL DEFAULT nextval('users_id_seq'::regclass),\n  uuid UUID NOT NULL DEFAULT uuid_generate_v4(),\n  name VARCHAR(255) NOT NULL,\n  email VARCHAR(255) NOT NULL,\n  password_hash VARCHAR(255) NOT NULL,\n  user_type VARCHAR(50) DEFAULT 'HOTEL'::character varying,\n  active BOOLEAN DEFAULT true,\n  email_verified BOOLEAN DEFAULT false,\n  created_at TIMESTAMP DEFAULT now(),\n  updated_at TIMESTAMP DEFAULT now()\n);\n\nALTER TABLE users ADD PRIMARY KEY (id);\n\n-- Tabela: workspaces\nCREATE TABLE IF NOT EXISTS workspaces (\n  id INTEGER NOT NULL DEFAULT nextval('workspaces_id_seq'::regclass),\n  uuid UUID NOT NULL DEFAULT uuid_generate_v4(),\n  hotel_id INTEGER,\n  hotel_uuid UUID,\n  name VARCHAR(255) NOT NULL,\n  description TEXT,\n  settings JSONB DEFAULT '{}'::jsonb,\n  active BOOLEAN DEFAULT true,\n  created_at TIMESTAMP DEFAULT now(),\n  updated_at TIMESTAMP DEFAULT now()\n);\n\nALTER TABLE workspaces ADD PRIMARY KEY (id);\n\n-- Views\n-- View: rate_shopper_dashboard_summary\nCREATE OR REPLACE VIEW rate_shopper_dashboard_summary AS\n SELECT h.id AS hotel_id,
    h.name AS hotel_name,
    count(DISTINCT p.id) AS total_properties,
    count(DISTINCT s.id) AS total_searches,
    count(DISTINCT rsp.id) AS total_prices,
    avg(rsp.price) AS avg_price,
    min(rsp.price) AS min_price,
    max(rsp.price) AS max_price,
    max(s.completed_at) AS last_search
   FROM (((hotels h
     LEFT JOIN rate_shopper_properties p ON (((h.id = p.hotel_id) AND (p.active = true))))
     LEFT JOIN rate_shopper_searches s ON ((h.id = s.hotel_id)))
     LEFT JOIN rate_shopper_prices rsp ON ((s.id = rsp.search_id)))
  GROUP BY h.id, h.name;;\n\n-- View: rate_shopper_latest_prices\nCREATE OR REPLACE VIEW rate_shopper_latest_prices AS\n SELECT p.id AS property_id,
    p.property_name,
    p.hotel_id,
    rsp.check_in_date,
    rsp.check_out_date,
    rsp.price,
    rsp.currency,
    rsp.availability_status,
    rsp.scraped_at,
    s.search_type
   FROM ((rate_shopper_prices rsp
     JOIN rate_shopper_properties p ON ((rsp.property_id = p.id)))
     JOIN rate_shopper_searches s ON ((rsp.search_id = s.id)))
  WHERE (rsp.scraped_at = ( SELECT max(rsp2.scraped_at) AS max
           FROM rate_shopper_prices rsp2
          WHERE ((rsp2.property_id = rsp.property_id) AND (rsp2.check_in_date = rsp.check_in_date))));;\n\n